# Story 5.3 : Graphes Visualisation (Widgets Dashboard)

**Epic**: Epic 5 - Dashboards & Visualisation
**Priorit√©**: HAUTE
**Estimation**: 3 points
**Status**: In Progress

## Contexte

Avec le Dashboard am√©lior√© (Story 5.5) et la Heatmap (Story 5.2), nous avons maintenant besoin de graphiques interactifs suppl√©mentaires pour enrichir l'analyse visuelle des plannings.

Ces graphiques serviront de **widgets visuels** dans le Dashboard et la page R√©sultats pour permettre une analyse rapide et intuitive de la qualit√© du planning.

## Objectif

Cr√©er des graphiques interactifs Plotly pour visualiser :
- **Distribution des rencontres** par participant (bar chart)
- **√âvolution √©quit√©** √† travers les sessions (line chart - optionnel)
- **Pie chart** r√©partition paires (uniques vs r√©p√©titions)
- Tous les graphiques doivent √™tre **coh√©rents visuellement** avec le Dashboard

## User Story

**En tant qu'** organisateur d'√©v√©nement
**Je veux** voir des graphiques visuels clairs sur la distribution des rencontres
**Afin de** comprendre rapidement l'√©quit√© et identifier les participants sous/sur-expos√©s

## Acceptance Criteria

### AC1: Bar Chart Distribution Rencontres
- [ ] Graphique barre montrant rencontres uniques par participant
- [ ] Axe X : Participant ID ou nom (si disponible)
- [ ] Axe Y : Nombre rencontres uniques
- [ ] Ligne horizontale pointill√©e pour moyenne
- [ ] Couleur gradient selon valeur (vert = moyen, rouge = extr√™mes)
- [ ] Hover tooltip avec d√©tails participant

### AC2: Pie Chart Paires Uniques vs R√©p√©titions
- [ ] Camembert montrant r√©partition :
  - Paires uniques (1 rencontre)
  - Paires r√©p√©t√©es (2+ rencontres)
- [ ] Pourcentages affich√©s sur segments
- [ ] Couleurs coh√©rentes (vert pour uniques, orange pour r√©p√©titions)
- [ ] Total paires dans titre

### AC3: Int√©gration Dashboard
- [ ] Fonction `create_distribution_chart()` impl√©ment√©e dans `src/visualizations.py`
- [ ] Fonction `create_pairs_pie_chart()` ajout√©e dans `src/visualizations.py`
- [ ] Graphiques ajout√©s dans Dashboard (expander optionnel)
- [ ] Graphiques ajout√©s dans page R√©sultats (tab M√©triques)

### AC4: Styling Coh√©rent
- [ ] Couleurs coh√©rentes avec Dashboard (vert/jaune/rouge)
- [ ] Taille responsive (use_container_width=True)
- [ ] Titres clairs et informatifs
- [ ] Pas d'emojis dans les titres de graphiques

### AC5: Performance
- [ ] Fluide jusqu'√† N=100
- [ ] Warning si N > 200
- [ ] G√©n√©ration < 1s pour N=50

## Design Technique

### 1. Bar Chart Distribution (src/visualizations.py)

```python
def create_distribution_chart(
    unique_meetings_per_person: list,
    participants_df: Optional[pd.DataFrame] = None,
    title: str = "Distribution des Rencontres par Participant",
    show_mean: bool = True
) -> go.Figure:
    """Cr√©e bar chart distribution rencontres uniques par participant.

    Args:
        unique_meetings_per_person: Liste nombre rencontres par participant
        participants_df: DataFrame participants pour noms sur axe X (optionnel)
        title: Titre du graphique
        show_mean: Afficher ligne moyenne (d√©faut: True)

    Returns:
        Figure Plotly interactive

    Example:
        >>> from src.metrics import compute_metrics
        >>> metrics = compute_metrics(planning, config, participants)
        >>> fig = create_distribution_chart(
        ...     metrics.unique_meetings_per_person,
        ...     participants_df
        ... )
        >>> st.plotly_chart(fig, use_container_width=True)

    Design:
        - Gradient couleur : valeurs proches moyenne = vert, extr√™mes = rouge
        - Ligne pointill√©e horizontale pour moyenne
        - Hover : "Participant X : Y rencontres"
    """
    N = len(unique_meetings_per_person)
    mean_value = sum(unique_meetings_per_person) / N if N > 0 else 0

    # Construire labels axe X
    x_labels = []
    for i in range(N):
        if participants_df is not None and not participants_df.empty:
            name = get_participant_display_name(i, participants_df)
            x_labels.append(name)
        else:
            x_labels.append(f"P{i}")

    # Cr√©er bar chart
    fig = go.Figure(data=go.Bar(
        x=x_labels,
        y=unique_meetings_per_person,
        marker=dict(
            color=unique_meetings_per_person,
            colorscale='RdYlGn',  # Rouge-Jaune-Vert
            reversescale=False,
            colorbar=dict(title="Rencontres")
        ),
        text=unique_meetings_per_person,
        textposition='outside',
        hovertemplate='<b>%{x}</b><br>Rencontres: %{y}<extra></extra>'
    ))

    # Ajouter ligne moyenne
    if show_mean:
        fig.add_hline(
            y=mean_value,
            line_dash="dash",
            line_color="blue",
            annotation_text=f"Moyenne: {mean_value:.1f}",
            annotation_position="right"
        )

    # Layout
    fig.update_layout(
        title=title,
        xaxis_title="Participants",
        yaxis_title="Rencontres Uniques",
        showlegend=False,
        height=500,
        xaxis=dict(
            tickangle=45 if N > 20 else 0
        )
    )

    return fig
```

### 2. Pie Chart Paires (src/visualizations.py)

```python
def create_pairs_pie_chart(
    stats: Dict[str, any],
    title: str = "R√©partition Paires Uniques vs R√©p√©titions"
) -> go.Figure:
    """Cr√©e pie chart r√©partition paires uniques vs r√©p√©t√©es.

    Args:
        stats: Statistiques matrice (total_pairs_met, repeat_pairs, etc.)
        title: Titre du graphique

    Returns:
        Figure Plotly interactive

    Example:
        >>> matrix = compute_meetings_matrix(planning, config.N)
        >>> stats = compute_matrix_statistics(matrix)
        >>> fig = create_pairs_pie_chart(stats)
        >>> st.plotly_chart(fig, use_container_width=True)

    Design:
        - Vert : Paires uniques (1 rencontre)
        - Orange : Paires r√©p√©t√©es (2+ rencontres)
        - Pourcentages affich√©s sur segments
    """
    # Calculer paires uniques (1 rencontre) vs r√©p√©t√©es (2+ rencontres)
    total_pairs_met = stats['total_pairs_met']
    repeat_pairs = stats['repeat_pairs']
    unique_only_pairs = total_pairs_met - repeat_pairs

    labels = ['Paires Uniques (1 fois)', 'Paires R√©p√©t√©es (2+ fois)']
    values = [unique_only_pairs, repeat_pairs]
    colors = ['#2ecc71', '#e67e22']  # Vert, Orange

    fig = go.Figure(data=go.Pie(
        labels=labels,
        values=values,
        marker=dict(colors=colors),
        textinfo='label+percent+value',
        hovertemplate='<b>%{label}</b><br>%{value} paires (%{percent})<extra></extra>'
    ))

    fig.update_layout(
        title=f"{title}<br><sub>Total paires rencontr√©es: {total_pairs_met}</sub>",
        showlegend=True,
        height=400
    )

    return fig
```

### 3. Int√©gration Dashboard

Ajouter dans `app/pages/1_üìä_Dashboard.py` apr√®s la section "M√©triques D√©taill√©es" :

```python
st.divider()

# ===== GRAPHIQUES VISUALISATION (Story 5.3) =====
with st.expander("üìä Graphiques Visualisation", expanded=False):
    st.markdown("### Distribution Rencontres")

    from src.visualizations import create_distribution_chart
    fig_dist = create_distribution_chart(
        metrics.unique_meetings_per_person,
        participants_df
    )
    st.plotly_chart(fig_dist, use_container_width=True)

    st.divider()

    st.markdown("### R√©partition Paires")
    from src.visualizations import create_pairs_pie_chart
    fig_pie = create_pairs_pie_chart(stats)
    st.plotly_chart(fig_pie, use_container_width=True)
```

### 4. Int√©gration Page R√©sultats

Dans `app/pages/4_üìà_R√©sultats.py`, remplacer le bar chart existant (lignes 122-146) par :

```python
# Distribution avec noms participants
from src.visualizations import create_distribution_chart
fig_dist = create_distribution_chart(
    metrics.unique_meetings_per_person,
    participants_df
)
st.plotly_chart(fig_dist, use_container_width=True)
```

## Tasks d'Impl√©mentation

- [ ] **Task 1**: Impl√©menter `create_distribution_chart()` dans `src/visualizations.py`
- [ ] **Task 2**: Impl√©menter `create_pairs_pie_chart()` dans `src/visualizations.py`
- [ ] **Task 3**: Int√©grer graphiques dans Dashboard (expander)
- [ ] **Task 4**: Remplacer bar chart dans page R√©sultats
- [ ] **Task 5**: Tests manuels (N=10, N=50, avec/sans participants)
- [ ] **Task 6**: Tests unitaires (optionnel - graphiques test√©s en manuel)

## Testing

### Tests Manuels

1. **Dashboard** :
   - G√©n√©rer planning N=20
   - V√©rifier expander "Graphiques Visualisation"
   - Distribution chart : noms participants sur axe X, ligne moyenne
   - Pie chart : r√©partition coh√©rente avec m√©triques

2. **Page R√©sultats** :
   - Tab "M√©triques" ‚Üí Distribution chart avec noms
   - Hover tooltips fonctionnels

3. **Performance** :
   - N=10 : instantan√©
   - N=50 : < 1s
   - N=100 : fluide

### Tests Unitaires (Optionnel)

Tests basiques pour s'assurer que les fonctions ne crashent pas :

```python
# tests/test_visualizations.py
def test_create_distribution_chart_basic():
    """Test cr√©ation distribution chart sans participants."""
    from src.visualizations import create_distribution_chart

    unique_meetings = [10, 11, 10, 11, 10]
    fig = create_distribution_chart(unique_meetings, participants_df=None)

    assert fig is not None
    assert len(fig.data) == 1  # 1 trace bar chart

def test_create_pairs_pie_chart_basic():
    """Test cr√©ation pie chart."""
    from src.visualizations import create_pairs_pie_chart

    stats = {
        'total_pairs_met': 45,
        'repeat_pairs': 5
    }

    fig = create_pairs_pie_chart(stats)

    assert fig is not None
    assert len(fig.data) == 1  # 1 trace pie chart
```

## Crit√®res de Succ√®s

- ‚úÖ Distribution chart interactif avec gradient couleurs
- ‚úÖ Pie chart r√©partition paires
- ‚úÖ Int√©gration Dashboard (expander)
- ‚úÖ Int√©gration page R√©sultats (remplacement bar chart)
- ‚úÖ Performance fluide jusqu'√† N=100
- ‚úÖ Styling coh√©rent avec Dashboard

## Temps Estim√©

- Impl√©mentation : 2h
- Tests : 1h
- **Total : 3h**

## Notes Techniques

- **Plotly vs Matplotlib** : On utilise Plotly pour coh√©rence avec heatmap (Story 5.2)
- **Gradient couleurs** : `colorscale='RdYlGn'` (Rouge-Jaune-Vert) pour distribution
- **Responsive** : Tous les graphiques avec `use_container_width=True`
- **Hover tooltips** : Format uniforme `<b>Label</b><br>Valeur<extra></extra>`
