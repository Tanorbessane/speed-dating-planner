# Story 5.5 : Dashboard AmÃ©liorÃ© avec KPIs (Home Page)

**Epic**: Epic 5 - Dashboards & Visualisation
**PrioritÃ©**: TRÃˆS HAUTE (Page d'accueil produit)
**Estimation**: 4 points
**Status**: In Progress

## Contexte

Actuellement, la page Dashboard (1_ğŸ“Š_Dashboard.py) est basique. Avec les amÃ©liorations des Stories 5.1 et 5.2, on peut crÃ©er une vraie **page d'accueil produit** qui :
- Montre **la qualitÃ© globale du planning en 1 coup d'Å“il**
- Affiche des **KPIs visuels clairs** (mÃ©triques + delta + couleurs)
- Fournit des **interprÃ©tations automatiques** (excellent/bon/Ã  amÃ©liorer)
- Devient la **vitrine dÃ©mo** : "VoilÃ  ce que vous obtenez !"

## Objectif

Transformer la page Dashboard en **home page produit** avec :
- **Hero section** : Titre + score qualitÃ© global
- **KPIs principaux** : 4-6 mÃ©triques clÃ©s visuelles
- **InterprÃ©tations automatiques** : Feedback intelligent sur qualitÃ©
- **AccÃ¨s rapide heatmap** : Bouton "Voir Heatmap" â†’ page RÃ©sultats
- **Actions recommandÃ©es** : Prochaines Ã©tapes suggÃ©rÃ©es

## User Story

**En tant qu'** organisateur d'Ã©vÃ©nement
**Je veux** voir immÃ©diatement la qualitÃ© de mon planning sur une page d'accueil
**Afin de** comprendre en quelques secondes si mon planning est optimal et quelles actions entreprendre

## Acceptance Criteria

### AC1: Hero Section - Score QualitÃ© Global
- [ ] Titre clair : "ğŸ“Š Dashboard - Planning OptimisÃ©"
- [ ] Score qualitÃ© global : 0-100 (calculÃ© depuis mÃ©triques)
- [ ] Badge visuel : ğŸŸ¢ Excellent (â‰¥90) / ğŸŸ¡ Bon (70-89) / ğŸ”´ Ã€ amÃ©liorer (<70)
- [ ] Sous-titre avec rÃ©sumÃ© : "X participants, Y sessions, Z% couverture"

### AC2: KPIs Principaux (4-6 MÃ©triques Visuelles)
- [ ] **Participants** : N participants total
- [ ] **Couverture** : X% des paires rencontrÃ©es (avec delta vs thÃ©orique)
- [ ] **Ã‰quitÃ©** : Equity gap â‰¤ 1 âœ… ou > 1 âš ï¸
- [ ] **RÃ©pÃ©titions** : Y paires rÃ©pÃ©tÃ©es (avec % vs total)
- [ ] **Max Rencontres** : Z rencontres max entre une paire
- [ ] **Sessions** : S sessions rÃ©alisÃ©es

### AC3: InterprÃ©tations Automatiques
- [ ] Analyse **Ã©quitÃ©** : âœ… Parfait si gap â‰¤ 1, âš ï¸ sinon
- [ ] Analyse **rÃ©pÃ©titions** : âœ… Optimal si 0, â„¹ï¸ acceptable si < 10%, âš ï¸ si â‰¥ 10%
- [ ] Analyse **couverture** : âœ… Excellent si â‰¥ 90%, â„¹ï¸ bon si â‰¥ 70%, âš ï¸ sinon
- [ ] **Recommandations** : Suggestions actions concrÃ¨tes si non-optimal

### AC4: AccÃ¨s Rapide Visualisations
- [ ] Bouton "ğŸ—ºï¸ Voir Heatmap" â†’ redirige vers page RÃ©sultats onglet Heatmap
- [ ] Mini-preview heatmap (petit) ou icÃ´ne cliquable
- [ ] Liens rapides : "ğŸ“ˆ Voir DÃ©tails", "ğŸ’¾ Exporter Planning"

### AC5: MÃ©triques DÃ©taillÃ©es (Expandable)
- [ ] Expander "ğŸ“Š MÃ©triques DÃ©taillÃ©es" avec :
  - Distribution rencontres (min, max, moyenne)
  - Statistiques VIP (si applicable)
  - Respect contraintes (si applicable)

### AC6: Actions RecommandÃ©es
- [ ] Section "ğŸ¯ Prochaines Ã‰tapes" avec :
  - Si planning non gÃ©nÃ©rÃ© : "GÃ©nÃ©rer planning" (lien)
  - Si optimal : "Exporter planning", "Partager rÃ©sultats"
  - Si non-optimal : "Augmenter sessions", "Voir heatmap pour analyser", etc.

### AC7: Design Professionnel
- [ ] Utilisation couleurs cohÃ©rentes (vert=bon, orange=moyen, rouge=problÃ¨me)
- [ ] IcÃ´nes clairs et intuitifs
- [ ] Layout responsive (colonnes adaptatives)
- [ ] Spacing professionnel entre sections

## Design Technique

### 1. Calcul Score QualitÃ© Global (src/analysis.py)

```python
def compute_quality_score(metrics: PlanningMetrics, stats: dict) -> dict:
    """Calcule score qualitÃ© global du planning (0-100).

    PondÃ©ration :
    - Ã‰quitÃ© (40%) : 100 si gap â‰¤ 1, 0 si gap > 3
    - Couverture (30%) : % couverture directement
    - RÃ©pÃ©titions (30%) : 100 si 0%, dÃ©croÃ®t selon %

    Args:
        metrics: PlanningMetrics
        stats: Statistiques matrice (coverage_rate, repeat_pairs, etc.)

    Returns:
        Dict avec :
        - score (0-100)
        - grade ("Excellent" / "Bon" / "Ã€ amÃ©liorer")
        - color ("green" / "yellow" / "red")

    Example:
        >>> score_data = compute_quality_score(metrics, stats)
        >>> score_data['score']
        92
        >>> score_data['grade']
        'Excellent'
    """
    # Ã‰quitÃ© (40 points)
    if metrics.equity_gap <= 1:
        equity_score = 40
    elif metrics.equity_gap == 2:
        equity_score = 25
    elif metrics.equity_gap == 3:
        equity_score = 10
    else:
        equity_score = 0

    # Couverture (30 points)
    coverage_score = 30 * (stats['coverage_rate'] / 100)

    # RÃ©pÃ©titions (30 points)
    repeat_pct = 100 * stats['repeat_pairs'] / stats['total_possible_pairs']
    if repeat_pct == 0:
        repeat_score = 30
    elif repeat_pct < 5:
        repeat_score = 25
    elif repeat_pct < 10:
        repeat_score = 15
    else:
        repeat_score = max(0, 30 - repeat_pct)

    # Score total
    total_score = round(equity_score + coverage_score + repeat_score)

    # Grade
    if total_score >= 90:
        grade = "Excellent"
        color = "green"
        emoji = "ğŸŸ¢"
    elif total_score >= 70:
        grade = "Bon"
        color = "yellow"
        emoji = "ğŸŸ¡"
    else:
        grade = "Ã€ amÃ©liorer"
        color = "red"
        emoji = "ğŸ”´"

    return {
        "score": total_score,
        "grade": grade,
        "color": color,
        "emoji": emoji
    }
```

### 2. Structure Dashboard (app/pages/1_ğŸ“Š_Dashboard.py)

```python
import streamlit as st
from src.analysis import compute_meetings_matrix, compute_matrix_statistics, compute_quality_score

st.set_page_config(page_title="Dashboard", page_icon="ğŸ“Š", layout="wide")

# ===== VÃ‰RIFIER PLANNING EXISTE =====
if "planning" not in st.session_state or st.session_state.planning is None:
    st.title("ğŸ“Š Dashboard - Speed Dating Planner")

    st.info("""
    ğŸ‘‹ **Bienvenue dans Speed Dating Planner !**

    Pour commencer, vous devez gÃ©nÃ©rer un planning :
    1. Configurez les paramÃ¨tres dans **âš™ï¸ Configuration**
    2. (Optionnel) Importez vos participants dans **ğŸ‘¥ Participants**
    3. GÃ©nÃ©rez votre planning dans **ğŸ¯ GÃ©nÃ©ration**
    4. Revenez ici pour voir la qualitÃ© !
    """)

    if st.button("ğŸš€ Aller Ã  Configuration", type="primary", use_container_width=True):
        st.switch_page("pages/2_âš™ï¸_Configuration.py")

    st.stop()

# ===== RÃ‰CUPÃ‰RER DONNÃ‰ES =====
planning = st.session_state.planning
metrics = st.session_state.metrics
config = st.session_state.config
participants_df = st.session_state.get("participants", None)

# Calculer matrice et stats
matrix = compute_meetings_matrix(planning, config.N)
stats = compute_matrix_statistics(matrix)

# Calculer score qualitÃ©
quality = compute_quality_score(metrics, stats)

# ===== HERO SECTION =====
st.title("ğŸ“Š Dashboard - Planning OptimisÃ©")

col1, col2, col3 = st.columns([2, 1, 1])

with col1:
    st.markdown(f"""
    ### {quality['emoji']} QualitÃ© : **{quality['grade']}** ({quality['score']}/100)

    {config.N} participants â€¢ {config.S} sessions â€¢ {stats['coverage_rate']:.1f}% couverture
    """)

with col2:
    st.metric(
        "Score QualitÃ©",
        f"{quality['score']}/100",
        delta=f"{quality['grade']}"
    )

with col3:
    if st.button("ğŸ—ºï¸ Voir Heatmap", use_container_width=True):
        st.switch_page("pages/4_ğŸ“ˆ_RÃ©sultats.py")

st.divider()

# ===== KPIS PRINCIPAUX =====
st.markdown("### ğŸ“Š KPIs Principaux")

col1, col2, col3, col4, col5, col6 = st.columns(6)

with col1:
    st.metric("ğŸ‘¥ Participants", config.N)

with col2:
    coverage_delta = f"+{stats['coverage_rate']:.0f}%" if stats['coverage_rate'] > 0 else "0%"
    st.metric("ğŸ“ˆ Couverture", f"{stats['coverage_rate']:.1f}%", delta=coverage_delta)

with col3:
    equity_emoji = "âœ…" if metrics.equity_gap <= 1 else "âš ï¸"
    st.metric(f"{equity_emoji} Ã‰quitÃ©", f"Gap: {metrics.equity_gap}")

with col4:
    repeat_pct = 100 * stats['repeat_pairs'] / stats['total_possible_pairs'] if stats['total_possible_pairs'] > 0 else 0
    st.metric("ğŸ”„ RÃ©pÃ©titions", f"{stats['repeat_pairs']}", delta=f"{repeat_pct:.1f}%")

with col5:
    st.metric("ğŸ¯ Max Rencontres", stats['max_meetings'])

with col6:
    st.metric("ğŸ“… Sessions", config.S)

st.divider()

# ===== INTERPRÃ‰TATIONS =====
st.markdown("### ğŸ’¡ Analyse QualitÃ©")

# Ã‰quitÃ©
if metrics.equity_gap <= 1:
    st.success("âœ… **Ã‰quitÃ© parfaite** : Tous les participants ont un nombre de rencontres Ã©quilibrÃ© (FR6 respectÃ©)")
else:
    st.warning(f"âš ï¸ **Ã‰quitÃ© Ã  amÃ©liorer** : Ã‰cart de {metrics.equity_gap} rencontres entre participants. Objectif : â‰¤ 1")

# Couverture
if stats['coverage_rate'] >= 90:
    st.success(f"âœ… **Excellente couverture** : {stats['coverage_rate']:.1f}% des paires se sont rencontrÃ©es")
elif stats['coverage_rate'] >= 70:
    st.info(f"â„¹ï¸ **Bonne couverture** : {stats['coverage_rate']:.1f}% des paires se sont rencontrÃ©es")
else:
    st.warning(f"âš ï¸ **Couverture Ã  amÃ©liorer** : Seulement {stats['coverage_rate']:.1f}% des paires rencontrÃ©es. Augmentez le nombre de sessions.")

# RÃ©pÃ©titions
if stats['repeat_pairs'] == 0:
    st.success("âœ… **Planning optimal** : Aucune rÃ©pÃ©tition ! Chaque paire ne se rencontre qu'une fois (FR5)")
elif repeat_pct < 10:
    st.info(f"â„¹ï¸ **RÃ©pÃ©titions acceptables** : {stats['repeat_pairs']} paires ({repeat_pct:.1f}%)")
else:
    st.warning(f"âš ï¸ **Nombreuses rÃ©pÃ©titions** : {stats['repeat_pairs']} paires ({repeat_pct:.1f}%). Ajustez la configuration.")

st.divider()

# ===== MÃ‰TRIQUES DÃ‰TAILLÃ‰ES =====
with st.expander("ğŸ“Š MÃ©triques DÃ©taillÃ©es"):
    col1, col2 = st.columns(2)

    with col1:
        st.markdown("**Distribution Rencontres**")
        st.write(f"- Min : {metrics.min_unique} rencontres")
        st.write(f"- Max : {metrics.max_unique} rencontres")
        st.write(f"- Moyenne : {metrics.mean_unique:.1f} rencontres")
        st.write(f"- Equity Gap : {metrics.equity_gap}")

    with col2:
        st.markdown("**Statistiques Paires**")
        st.write(f"- Paires uniques : {metrics.total_unique_pairs}")
        st.write(f"- RÃ©pÃ©titions : {metrics.total_repeat_pairs}")
        st.write(f"- Paires possibles : {stats['total_possible_pairs']}")
        st.write(f"- Taux unicitÃ© : {100 - repeat_pct:.1f}%")

    # VIP metrics si disponibles
    if metrics.vip_metrics:
        st.divider()
        st.markdown("**â­ MÃ©triques VIP**")
        vip = metrics.vip_metrics

        col1, col2 = st.columns(2)
        with col1:
            st.write(f"**VIP ({vip.vip_count})** : {vip.vip_min_unique}-{vip.vip_max_unique} rencontres (gap: {vip.vip_equity_gap})")
        with col2:
            st.write(f"**RÃ©guliers ({vip.non_vip_count})** : {vip.non_vip_min_unique}-{vip.non_vip_max_unique} rencontres (gap: {vip.non_vip_equity_gap})")

st.divider()

# ===== ACTIONS RECOMMANDÃ‰ES =====
st.markdown("### ğŸ¯ Prochaines Ã‰tapes")

if quality['score'] >= 90:
    st.success("ğŸ‰ Votre planning est excellent ! Vous pouvez :")
    col1, col2, col3 = st.columns(3)
    with col1:
        if st.button("ğŸ’¾ Exporter CSV/JSON", use_container_width=True):
            st.switch_page("pages/4_ğŸ“ˆ_RÃ©sultats.py")
    with col2:
        if st.button("ğŸ—ºï¸ Analyser Heatmap", use_container_width=True):
            st.switch_page("pages/4_ğŸ“ˆ_RÃ©sultats.py")
    with col3:
        if st.button("ğŸ”„ GÃ©nÃ©rer Variante", use_container_width=True):
            st.switch_page("pages/3_ğŸ¯_GÃ©nÃ©ration.py")
else:
    st.info("ğŸ’¡ Recommandations pour amÃ©liorer votre planning :")

    recommendations = []

    if metrics.equity_gap > 1:
        recommendations.append("- âš–ï¸ **AmÃ©liorer Ã©quitÃ©** : L'algorithme devrait avoir atteint gap â‰¤ 1. VÃ©rifiez les contraintes.")

    if stats['coverage_rate'] < 70:
        recommendations.append("- ğŸ“ˆ **Augmenter couverture** : Ajoutez des sessions (actuellement {config.S})")

    if repeat_pct >= 10:
        recommendations.append("- ğŸ”„ **RÃ©duire rÃ©pÃ©titions** : Augmentez le nombre de participants par table ou rÃ©duisez les sessions")

    for rec in recommendations:
        st.markdown(rec)

    col1, col2 = st.columns(2)
    with col1:
        if st.button("âš™ï¸ Modifier Configuration", use_container_width=True):
            st.switch_page("pages/2_âš™ï¸_Configuration.py")
    with col2:
        if st.button("ğŸ”„ RÃ©gÃ©nÃ©rer Planning", use_container_width=True):
            st.switch_page("pages/3_ğŸ¯_GÃ©nÃ©ration.py")
```

## Tasks d'ImplÃ©mentation

- [ ] **Task 1**: Ajouter `compute_quality_score()` dans `src/analysis.py`
- [ ] **Task 2**: RÃ©Ã©crire complÃ¨tement `app/pages/1_ğŸ“Š_Dashboard.py` avec nouvelle structure
- [ ] **Task 3**: Ajouter fonction helper `st.switch_page()` pour navigation
- [ ] **Task 4**: Styling cohÃ©rent (couleurs, icÃ´nes, spacing)
- [ ] **Task 5**: Tests manuels (N=10, N=50, avec/sans participants, avec/sans VIP)
- [ ] **Task 6**: Tests unitaires pour `compute_quality_score()`

## Testing

### Tests Unitaires (tests/test_analysis.py - ajouter)

```python
def test_compute_quality_score_excellent():
    """Score excellent (â‰¥90) si Ã©quitÃ© parfaite + bonne couverture + pas de rÃ©pÃ©titions."""
    # Mock metrics
    metrics = PlanningMetrics(
        total_unique_pairs=45,
        total_repeat_pairs=0,
        unique_meetings_per_person=[10]*10,
        min_unique=10,
        max_unique=10,
        mean_unique=10.0,
        vip_metrics=None
    )

    # Mock stats
    stats = {
        'total_pairs_met': 45,
        'total_possible_pairs': 45,
        'coverage_rate': 100.0,
        'repeat_pairs': 0,
        'max_meetings': 1
    }

    quality = compute_quality_score(metrics, stats)

    assert quality['score'] >= 90
    assert quality['grade'] == "Excellent"
    assert quality['emoji'] == "ğŸŸ¢"
```

## CritÃ¨res de SuccÃ¨s

- âœ… Dashboard devient vraie page d'accueil produit
- âœ… Score qualitÃ© global calculÃ© et affichÃ© clairement
- âœ… KPIs visuels avec st.metric() + delta
- âœ… InterprÃ©tations automatiques pertinentes
- âœ… Actions recommandÃ©es adaptÃ©es au score
- âœ… Navigation fluide vers autres pages
- âœ… Design professionnel et cohÃ©rent

## Temps EstimÃ©

- ImplÃ©mentation : 3h
- Tests : 1h
- **Total : 4h**
