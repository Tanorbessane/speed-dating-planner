# Story 1.3: Implémenter la Validation des Paramètres d'Entrée

## Status

**Draft**

---

## Story

**As a** organisateur d'événement,
**I want** que le système valide mes paramètres d'entrée et me donne des messages d'erreur clairs en français,
**so that** je sais immédiatement si ma configuration est viable avant de lancer la génération.

---

## Acceptance Criteria

1. Un module `src/validation.py` contient une fonction `validate_config(config: PlanningConfig) -> None` qui lance des exceptions typées
2. La validation vérifie toutes les contraintes FR1-FR2 :
   - N ≥ 2, X ≥ 1, x ≥ 2, S ≥ 1
   - X × x ≥ N (capacité suffisante)
3. Les exceptions personnalisées (`InvalidConfigurationError`) ont des messages en français explicites conformes à NFR10
4. Exemples de messages : "Nombre de participants invalide : N=0. Minimum requis : 2", "Capacité insuffisante : 5 tables × 4 places = 20 < 25 participants"
5. Les tests dans `tests/test_validation.py` couvrent tous les cas d'erreur avec vérification des messages français
6. Les tests vérifient qu'une configuration valide ne lève pas d'exception
7. La couverture de tests du module `validation.py` est ≥100%

---

## Tasks / Subtasks

- [ ] **Task 1: Créer module validation.py** (AC: 1)
  - [ ] Créer `src/validation.py`
  - [ ] Importer `PlanningConfig` et `InvalidConfigurationError` depuis models

- [ ] **Task 2: Implémenter validate_config()** (AC: 1, 2, 3, 4)
  - [ ] Créer fonction `validate_config(config: PlanningConfig) -> None`
  - [ ] Ajouter docstring Google style complète avec examples
  - [ ] Valider N ≥ 2 : lever InvalidConfigurationError avec message français
  - [ ] Valider X ≥ 1 : lever InvalidConfigurationError avec message français
  - [ ] Valider x ≥ 2 : lever InvalidConfigurationError avec message français
  - [ ] Valider S ≥ 1 : lever InvalidConfigurationError avec message français
  - [ ] Valider X × x ≥ N : lever InvalidConfigurationError avec message français détaillé

- [ ] **Task 3: Créer tests unitaires test_validation.py** (AC: 5, 6, 7)
  - [ ] Créer `tests/test_validation.py`
  - [ ] Test: config valide ne lève pas d'exception
  - [ ] Test: N=0 lève exception avec message "Nombre de participants invalide : N=0. Minimum requis : 2"
  - [ ] Test: N=1 lève exception avec message correct
  - [ ] Test: X=0 lève exception avec message "Nombre de tables invalide : X=0. Minimum requis : 1"
  - [ ] Test: x=0 lève exception avec message "Capacité de table invalide : x=0. Minimum requis : 2"
  - [ ] Test: x=1 lève exception avec message correct
  - [ ] Test: S=0 lève exception avec message "Nombre de sessions invalide : S=0. Minimum requis : 1"
  - [ ] Test: capacité insuffisante (X=5, x=4, N=25) lève exception avec message "Capacité insuffisante : 5 tables × 4 places = 20 < 25 participants"
  - [ ] Test: cas limite X×x = N (exact) passe
  - [ ] Test: cas limite N=2, X=1, x=2, S=1 (minimum absolu) passe

- [ ] **Task 4: Valider couverture et qualité** (AC: 7)
  - [ ] `pytest tests/test_validation.py --cov=src.validation --cov-report=term`
  - [ ] Vérifier couverture 100%
  - [ ] `mypy src/validation.py --strict`
  - [ ] `black` et `ruff` passent

---

## Dev Notes

### Dépendance sur Story Précédente

**Story 1.2 doit être complétée** - Cette story utilise `PlanningConfig` et `InvalidConfigurationError` de models.py.

### Implémentation Exacte

[Source: docs/architecture/interfaces-entre-modules.md#3.2]

```python
from src.models import PlanningConfig, InvalidConfigurationError

def validate_config(config: PlanningConfig) -> None:
    """
    Valide qu'une configuration respecte toutes les contraintes FR1-FR2.

    Args:
        config: Configuration à valider

    Raises:
        InvalidConfigurationError: Si la configuration est invalide avec message français explicite

    Examples:
        >>> validate_config(PlanningConfig(N=30, X=5, x=6, S=6))  # OK
        >>> validate_config(PlanningConfig(N=50, X=5, x=8, S=3))  # Lève exception
    """
    # FR1: Paramètres dans limites acceptables
    if config.N < 2:
        raise InvalidConfigurationError(
            f"Nombre de participants invalide : N={config.N}. Minimum requis : 2"
        )
    if config.X < 1:
        raise InvalidConfigurationError(
            f"Nombre de tables invalide : X={config.X}. Minimum requis : 1"
        )
    if config.x < 2:
        raise InvalidConfigurationError(
            f"Capacité de table invalide : x={config.x}. Minimum requis : 2"
        )
    if config.S < 1:
        raise InvalidConfigurationError(
            f"Nombre de sessions invalide : S={config.S}. Minimum requis : 1"
        )

    # FR2: Capacité totale suffisante
    total_capacity = config.X * config.x
    if total_capacity < config.N:
        raise InvalidConfigurationError(
            f"Capacité insuffisante : {config.X} tables × {config.x} places = "
            f"{total_capacity} < {config.N} participants"
        )
```

### Requirements Fonctionnels Concernés

[Source: docs/prd.md - Requirements]

**FR1:** Accepter paramètres N, X, x, S
**FR2:** Valider X × x ≥ N (capacité suffisante)
**NFR10:** Messages d'erreur en français

### Messages d'Erreur Standards

[Source: docs/architecture/gestion-des-erreurs-et-logging.md#7.1]

Tous les messages doivent être **explicites et en français** :
- Inclure la valeur problématique
- Indiquer la valeur minimale requise
- Pour capacité insuffisante : montrer le calcul (X tables × x places = total < N participants)

### Séparation des Validations

**IMPORTANT:** Séparation claire entre `models.py` et `validation.py` :

- **models.py (Story 1.2):** Validation des TYPES uniquement (TypeError)
- **validation.py (cette story):** Validation de la LOGIQUE métier (InvalidConfigurationError)

Cette séparation suit le principe de **Single Responsibility**.

---

## Testing

### Test Coverage Target: 100%

[Source: docs/architecture/stratégie-de-testing.md#5.2]

**Module critique** : validation.py doit avoir 100% de couverture car c'est la première ligne de défense contre configurations invalides.

### Tests Exhaustifs Requis

**Cas valides:**
- Config standard (N=30, X=5, x=6, S=6)
- Cas limite exact (N=10, X=2, x=5, S=1) → 2×5=10=N
- Minimum absolu (N=2, X=1, x=2, S=1)

**Cas invalides N:**
- N=0 → message exact
- N=1 → message exact
- N=-5 → message exact

**Cas invalides X:**
- X=0 → message exact
- X=-1 → message exact

**Cas invalides x:**
- x=0 → message exact
- x=1 → message exact
- x=-2 → message exact

**Cas invalides S:**
- S=0 → message exact
- S=-1 → message exact

**Cas capacité insuffisante:**
- X=5, x=4, N=25 → 5×4=20<25 → message avec calcul
- X=10, x=10, N=101 → 10×10=100<101 → message avec calcul

### Exemple de Test

```python
def test_validate_config_insufficient_capacity():
    """Test capacité insuffisante avec message détaillé."""
    config = PlanningConfig(N=25, X=5, x=4, S=5)
    with pytest.raises(InvalidConfigurationError,
                      match=r"Capacité insuffisante : 5 tables × 4 places = 20 < 25 participants"):
        validate_config(config)
```

### Commandes de Test

```bash
# Tests unitaires
pytest tests/test_validation.py -v

# Couverture (doit être 100%)
pytest tests/test_validation.py --cov=src.validation --cov-report=term --cov-fail-under=100

# Type checking
mypy src/validation.py --strict

# Tous checks
black src/validation.py tests/test_validation.py
ruff check src/validation.py tests/test_validation.py
mypy src/validation.py --strict
pytest tests/test_validation.py -v
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-10 | 1.0 | Story initiale créée par Scrum Master | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used

_À compléter par le dev agent_

### Debug Log References

_À compléter par le dev agent_

### Completion Notes List

_À compléter par le dev agent_

### File List

_À compléter par le dev agent_

---

## QA Results

_À compléter par le QA agent_

---

**Definition of Done:**
- [ ] Tous les AC (1-7) sont satisfaits
- [ ] Toutes les tâches et sous-tâches sont complétées
- [ ] `src/validation.py` créé avec validate_config()
- [ ] `tests/test_validation.py` créé avec tous les tests
- [ ] `pytest tests/test_validation.py` passe avec succès
- [ ] Couverture 100% pour `src/validation.py`
- [ ] `mypy --strict` passe sans erreur
- [ ] `black` et `ruff` passent sans erreur
- [ ] Tous les messages d'erreur en français vérifiés
- [ ] Docstring Google style complète
