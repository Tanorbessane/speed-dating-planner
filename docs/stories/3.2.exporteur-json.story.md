# Story 3.2: Implémenter l'Exporteur JSON

## Status

**Draft**

---

## Story

**As a** organisateur d'événement,
**I want** exporter mon planning au format JSON structuré,
**so that** je peux l'utiliser dans des applications web ou API sans parsing complexe.

---

## Acceptance Criteria

1. Une fonction `export_to_json(planning: Planning, config: PlanningConfig, filepath: str, include_metadata: bool = True) -> None` dans `src/exporters.py`
2. Le fichier JSON suit la structure exacte spécifiée dans FR11 : `{"sessions": [{"session_id": int, "tables": [{"table_id": int, "participants": [int]}]}]}`
3. Le JSON est indenté (2 espaces) pour lisibilité humaine
4. Le fichier est encodé en UTF-8
5. Les tests vérifient :
   - Export réussit sans erreur
   - JSON produit est valide (parsing avec `json.load` réussit)
   - Structure conforme à FR11
   - Valeurs correctes pour un planning connu
6. Un champ optionnel `metadata` peut être ajouté avec : `{"config": {"N": ..., "X": ..., "x": ..., "S": ...}, "total_participants": N, "total_sessions": S}`
7. Si le fichier existe déjà, il est écrasé (avec warning loggé)

---

## Tasks / Subtasks

- [ ] **Task 1: Implémenter export_to_json()** (AC: 1, 2, 3, 4, 6, 7)
  - [ ] Ajouter dans `src/exporters.py`
  - [ ] Signature:
    ```python
    def export_to_json(
        planning: Planning,
        config: PlanningConfig,
        filepath: str,
        include_metadata: bool = True
    ) -> None
    ```
  - [ ] Docstring Google style
  - [ ] Construire dict structure FR11:
    ```python
    data = {
        "sessions": [
            {
                "session_id": session.session_id,
                "tables": [
                    {
                        "table_id": table_id,
                        "participants": sorted(list(table))
                    }
                    for table_id, table in enumerate(session.tables)
                ]
            }
            for session in planning.sessions
        ]
    }
    ```
  - [ ] Si include_metadata:
    ```python
    data["metadata"] = {
        "config": {"N": config.N, "X": config.X, "x": config.x, "S": config.S},
        "total_participants": config.N,
        "total_sessions": config.S
    }
    ```
  - [ ] Vérifier fichier existe: logger.warning si écrasement
  - [ ] Écrire JSON: `json.dump(data, f, indent=2, ensure_ascii=False)`
  - [ ] Logger success

- [ ] **Task 2: Créer tests test_exporters.py pour JSON** (AC: 5)
  - [ ] Test export réussit
  - [ ] Test JSON valide (parsing)
  - [ ] Test structure FR11 conforme
  - [ ] Test valeurs correctes
  - [ ] Test metadata optionnelle
  - [ ] Test écrasement fichier

- [ ] **Task 3: Test JSON valide et parsable** (AC: 5)
  - [ ] Exporter planning
  - [ ] Lire avec json.load()
  - [ ] Vérifier parsing réussit sans exception
  - [ ] Vérifier clé 'sessions' présente

- [ ] **Task 4: Test structure FR11** (AC: 2, 5)
  - [ ] Vérifier structure exacte:
    ```python
    assert 'sessions' in data
    assert isinstance(data['sessions'], list)
    for session in data['sessions']:
        assert 'session_id' in session
        assert 'tables' in session
        for table in session['tables']:
            assert 'table_id' in table
            assert 'participants' in table
            assert isinstance(table['participants'], list)
    ```

- [ ] **Task 5: Test metadata optionnelle** (AC: 6)
  - [ ] Test avec include_metadata=True: vérifier metadata présente
  - [ ] Test avec include_metadata=False: vérifier metadata absente
  - [ ] Vérifier contenu metadata correct

- [ ] **Task 6: Test indentation lisible** (AC: 3)
  - [ ] Lire fichier JSON comme texte
  - [ ] Vérifier présence indentations (lignes commençant par espaces)
  - [ ] Vérifier format pretty-printed

- [ ] **Task 7: Valider couverture et qualité**
  - [ ] `pytest tests/test_exporters.py::test_export_json -v`
  - [ ] Couverture ≥90% pour exporters.py
  - [ ] `mypy src/exporters.py --strict`
  - [ ] `black` et `ruff` passent

- [ ] **Task 8: Créer QA Gate YAML**
  - [ ] Mettre à jour `docs/qa/gates/3.2-exporteur-json.yml`

---

## Dev Notes

### Dépendance

**Epic 1-2 + Story 3.1:**
- Models
- Story 3.1: module exporters.py créé

Cette story implémente **FR11** (export JSON).

### Format JSON - FR11

**Structure exacte:**
```json
{
  "sessions": [
    {
      "session_id": 0,
      "tables": [
        {
          "table_id": 0,
          "participants": [0, 1, 2]
        },
        {
          "table_id": 1,
          "participants": [3, 4, 5]
        }
      ]
    },
    {
      "session_id": 1,
      "tables": [
        ...
      ]
    }
  ],
  "metadata": {
    "config": {"N": 6, "X": 2, "x": 3, "S": 2},
    "total_participants": 6,
    "total_sessions": 2
  }
}
```

**Garanties:**
- participants toujours trié (sorted) pour déterminisme
- Indentation 2 espaces (lisibilité)
- UTF-8 sans BOM (standard JSON)
- ensure_ascii=False pour supporter caractères non-ASCII

---

## Testing

### Tests Clés

**1. Test structure FR11**
```python
def test_export_to_json_structure():
    # ... create planning, export
    with open(filepath) as f:
        data = json.load(f)

    assert 'sessions' in data
    assert len(data['sessions']) == 2

    session0 = data['sessions'][0]
    assert session0['session_id'] == 0
    assert len(session0['tables']) == 2

    table0 = session0['tables'][0]
    assert table0['table_id'] == 0
    assert isinstance(table0['participants'], list)
```

**2. Test metadata**
```python
def test_export_to_json_with_metadata():
    config = PlanningConfig(N=6, X=2, x=3, S=2)
    # ... export with include_metadata=True

    with open(filepath) as f:
        data = json.load(f)

    assert 'metadata' in data
    assert data['metadata']['config']['N'] == 6
    assert data['metadata']['total_participants'] == 6
```

**3. Test sans metadata**
```python
def test_export_to_json_without_metadata():
    # ... export with include_metadata=False
    with open(filepath) as f:
        data = json.load(f)
    assert 'metadata' not in data
```

---

## QA Gate

**Fichier:** `docs/qa/gates/3.2-exporteur-json.yml`

```yaml
story: 3.2-exporteur-json
checks:
  - name: Unit Tests
    command: pytest tests/test_exporters.py::test_export_json -v
    expected: All tests pass

  - name: JSON Structure FR11
    command: pytest tests/test_exporters.py::test_export_to_json_structure -v
    expected: Structure conforme

  - name: Coverage
    command: pytest tests/test_exporters.py --cov=src.exporters --cov-report=term --cov-fail-under=90
    expected: Coverage ≥90%

  - name: Type Checking
    command: mypy src/exporters.py --strict
    expected: No errors
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-10 | 1.0 | Story initiale créée par Scrum Master | Bob (SM) |

---

**Definition of Done:**
- [ ] `export_to_json()` implémentée dans `src/exporters.py`
- [ ] Tests `test_export_json_*` créés
- [ ] Structure JSON FR11 respectée
- [ ] JSON indenté 2 espaces, encodage UTF-8
- [ ] Test metadata optionnelle (include_metadata)
- [ ] Test JSON valide et parsable
- [ ] Couverture ≥90%
- [ ] `mypy --strict` passe
- [ ] QA Gate YAML créé
- [ ] **Granularité:** 1 story = 1 PR (exporteur JSON uniquement)
