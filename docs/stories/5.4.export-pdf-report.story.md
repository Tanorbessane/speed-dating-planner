# Story 5.4 : Export PDF avec Rapport Complet (Livrable Final)

**Epic**: Epic 5 - Dashboards & Visualisation
**Priorit√©**: HAUTE (Livrable client)
**Estimation**: 5 points
**Status**: In Progress

## Contexte

Avec le Dashboard professionnel (Story 5.5), la Heatmap (Story 5.2) et les graphiques (Story 5.3), nous avons maintenant besoin d'un **export PDF complet** pour fournir un livrable professionnel aux organisateurs d'√©v√©nements.

Ce PDF sera le **document final** remis aux clients, contenant :
- R√©sum√© ex√©cutif avec score qualit√©
- KPIs principaux
- Graphiques visuels (heatmap, distribution, pie chart)
- Planning complet avec toutes les sessions/tables

## Objectif

Cr√©er un export PDF professionnel et complet du planning avec :
- **Page de garde** avec titre, date, configuration
- **Section KPIs** : Score qualit√© + m√©triques principales
- **Graphiques** : Heatmap, distribution, r√©partition paires
- **Planning d√©taill√©** : Toutes les sessions/tables avec noms participants
- **Footer** : "G√©n√©r√© par Speed Dating Planner" avec logo (optionnel)

## User Story

**En tant qu'** organisateur d'√©v√©nement
**Je veux** exporter un rapport PDF complet de mon planning
**Afin de** le partager avec mon √©quipe et l'imprimer pour l'√©v√©nement

## Acceptance Criteria

### AC1: Page de Garde
- [ ] Titre : "Rapport Planning Speed Dating"
- [ ] Date de g√©n√©ration
- [ ] Configuration : N participants, X tables, x capacit√©, S sessions
- [ ] Score qualit√© global avec badge (Excellent/Bon/√Ä am√©liorer)

### AC2: Section R√©sum√© Ex√©cutif
- [ ] Score qualit√© 0-100 avec interpr√©tation
- [ ] 6 KPIs principaux (Participants, Couverture, √âquit√©, R√©p√©titions, Max Rencontres, Sessions)
- [ ] Interpr√©tations automatiques (√©quit√©, couverture, r√©p√©titions)

### AC3: Section Graphiques
- [ ] Heatmap matrice rencontres N√óN (export√©e en image PNG)
- [ ] Distribution chart (bar chart rencontres par participant)
- [ ] Pie chart r√©partition paires uniques vs r√©p√©t√©es
- [ ] Tous les graphiques en haute r√©solution (300 DPI)

### AC4: Planning D√©taill√©
- [ ] Toutes les sessions list√©es (Session 1, Session 2, ...)
- [ ] Pour chaque session : toutes les tables
- [ ] Pour chaque table : liste participants avec noms (si disponibles)
- [ ] Format lisible et imprimable

### AC5: M√©tadonn√©es et Footer
- [ ] Footer sur chaque page : "G√©n√©r√© par Speed Dating Planner"
- [ ] Num√©ros de page (Page X / Y)
- [ ] Date et heure de g√©n√©ration

### AC6: Int√©gration Streamlit
- [ ] Bouton "üìÑ T√©l√©charger Rapport PDF" dans page R√©sultats (tab Exports)
- [ ] G√©n√©ration PDF en m√©moire (BytesIO)
- [ ] Download automatique via st.download_button()
- [ ] Nom fichier : `planning_report_YYYYMMDD_HHMMSS.pdf`

### AC7: Performance
- [ ] G√©n√©ration < 5s pour N=50
- [ ] Warning si N > 100 (g√©n√©ration peut prendre 10-15s)
- [ ] Gestion erreurs (graphiques trop grands, m√©moire insuffisante)

## Design Technique

### 1. Module PDF Export (src/pdf_exporter.py)

Nous utiliserons **ReportLab** pour g√©n√©rer le PDF, car c'est la biblioth√®que standard Python pour PDFs professionnels.

```python
"""Module d'export PDF des plannings (Story 5.4).

G√©n√®re un rapport PDF complet avec :
- Page de garde
- KPIs et m√©triques
- Graphiques (heatmap, distribution, pie chart)
- Planning d√©taill√©

Dependencies:
    - reportlab : pip install reportlab
    - Pillow : pour conversion graphiques Plotly ‚Üí PNG
"""

from reportlab.lib.pagesizes import A4, letter
from reportlab.lib import colors
from reportlab.lib.units import inch
from reportlab.platypus import (
    SimpleDocTemplate, Table, TableStyle, Paragraph, Spacer, PageBreak, Image
)
from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
from reportlab.lib.enums import TA_CENTER, TA_LEFT
from io import BytesIO
from datetime import datetime
from typing import Optional
import pandas as pd

from src.models import Planning, PlanningConfig, PlanningMetrics
from src.analysis import compute_meetings_matrix, compute_matrix_statistics, compute_quality_score
from src.visualizations import create_meetings_heatmap, create_distribution_chart, create_pairs_pie_chart
from src.display_utils import get_participant_display_name


def export_to_pdf(
    planning: Planning,
    config: PlanningConfig,
    metrics: PlanningMetrics,
    participants_df: Optional[pd.DataFrame] = None,
    output_path: Optional[str] = None
) -> BytesIO:
    """G√©n√®re rapport PDF complet du planning.

    Args:
        planning: Planning √† exporter
        config: Configuration du planning
        metrics: M√©triques calcul√©es
        participants_df: DataFrame participants (optionnel, pour noms)
        output_path: Chemin fichier PDF (si None, retourne BytesIO)

    Returns:
        BytesIO contenant le PDF si output_path=None

    Example:
        >>> pdf_bytes = export_to_pdf(planning, config, metrics, participants_df)
        >>> st.download_button(
        ...     label="T√©l√©charger PDF",
        ...     data=pdf_bytes.getvalue(),
        ...     file_name="planning_report.pdf",
        ...     mime="application/pdf"
        ... )
    """
    # Calculer matrice et stats
    matrix = compute_meetings_matrix(planning, config.N)
    stats = compute_matrix_statistics(matrix)
    quality = compute_quality_score(metrics, stats)

    # Cr√©er BytesIO si pas de output_path
    buffer = BytesIO() if output_path is None else None
    output = buffer if buffer else output_path

    # Cr√©er document PDF
    doc = SimpleDocTemplate(
        output,
        pagesize=A4,
        rightMargin=inch/2,
        leftMargin=inch/2,
        topMargin=inch,
        bottomMargin=inch/2
    )

    # Styles
    styles = getSampleStyleSheet()
    title_style = ParagraphStyle(
        'CustomTitle',
        parent=styles['Heading1'],
        fontSize=24,
        textColor=colors.HexColor('#2c3e50'),
        spaceAfter=30,
        alignment=TA_CENTER
    )

    # Conteneur √©l√©ments PDF
    story = []

    # ===== PAGE DE GARDE =====
    story.append(Spacer(1, 2*inch))
    story.append(Paragraph("Rapport Planning Speed Dating", title_style))
    story.append(Spacer(1, 0.5*inch))

    # Date g√©n√©ration
    date_str = datetime.now().strftime("%d/%m/%Y %H:%M")
    story.append(Paragraph(f"<para align=center>G√©n√©r√© le {date_str}</para>", styles['Normal']))
    story.append(Spacer(1, 0.3*inch))

    # Configuration
    config_data = [
        ["Configuration Planning", ""],
        ["Participants", str(config.N)],
        ["Tables", str(config.X)],
        ["Capacit√©/table", str(config.x)],
        ["Sessions", str(config.S)],
    ]

    config_table = Table(config_data, colWidths=[3*inch, 2*inch])
    config_table.setStyle(TableStyle([
        ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#3498db')),
        ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
        ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
        ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
        ('FONTSIZE', (0, 0), (-1, 0), 14),
        ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
        ('BACKGROUND', (0, 1), (-1, -1), colors.beige),
        ('GRID', (0, 0), (-1, -1), 1, colors.black)
    ]))
    story.append(config_table)
    story.append(Spacer(1, 0.5*inch))

    # Score qualit√©
    quality_emoji = quality['emoji']
    quality_text = f"Score Qualit√© : {quality_emoji} {quality['grade']} ({quality['score']}/100)"
    story.append(Paragraph(f"<para align=center fontSize=16><b>{quality_text}</b></para>", styles['Normal']))

    story.append(PageBreak())

    # ===== SECTION KPIS =====
    story.append(Paragraph("KPIs Principaux", styles['Heading1']))
    story.append(Spacer(1, 0.2*inch))

    repeat_pct = 100 * stats['repeat_pairs'] / stats['total_possible_pairs'] if stats['total_possible_pairs'] > 0 else 0

    kpis_data = [
        ["M√©trique", "Valeur"],
        ["Participants", str(config.N)],
        ["Couverture", f"{stats['coverage_rate']:.1f}%"],
        ["√âquit√© (Gap)", str(metrics.equity_gap)],
        ["R√©p√©titions", f"{stats['repeat_pairs']} ({repeat_pct:.1f}%)"],
        ["Max Rencontres", str(stats['max_meetings'])],
        ["Sessions", str(config.S)],
    ]

    kpis_table = Table(kpis_data, colWidths=[3*inch, 2*inch])
    kpis_table.setStyle(TableStyle([
        ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#2ecc71')),
        ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
        ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
        ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
        ('GRID', (0, 0), (-1, -1), 1, colors.black)
    ]))
    story.append(kpis_table)

    story.append(PageBreak())

    # ===== SECTION GRAPHIQUES =====
    story.append(Paragraph("Graphiques Visualisation", styles['Heading1']))
    story.append(Spacer(1, 0.2*inch))

    # Exporter graphiques en PNG (via kaleido pour Plotly)
    # Note: Heatmap peut √™tre trop grande pour N > 50, donc warning
    if config.N <= 50:
        # Heatmap
        fig_heatmap = create_meetings_heatmap(matrix, participants_df)
        heatmap_img = _plotly_fig_to_image(fig_heatmap)
        if heatmap_img:
            story.append(Paragraph("Matrice des Rencontres", styles['Heading2']))
            story.append(heatmap_img)
            story.append(PageBreak())

    # Distribution chart
    fig_dist = create_distribution_chart(metrics.unique_meetings_per_person, participants_df)
    dist_img = _plotly_fig_to_image(fig_dist)
    if dist_img:
        story.append(Paragraph("Distribution Rencontres par Participant", styles['Heading2']))
        story.append(dist_img)
        story.append(Spacer(1, 0.3*inch))

    # Pie chart
    fig_pie = create_pairs_pie_chart(stats)
    pie_img = _plotly_fig_to_image(fig_pie)
    if pie_img:
        story.append(Paragraph("R√©partition Paires Uniques vs R√©p√©titions", styles['Heading2']))
        story.append(pie_img)

    story.append(PageBreak())

    # ===== PLANNING D√âTAILL√â =====
    story.append(Paragraph("Planning D√©taill√©", styles['Heading1']))
    story.append(Spacer(1, 0.2*inch))

    for session in planning.sessions:
        story.append(Paragraph(f"Session {session.session_id + 1}", styles['Heading2']))
        story.append(Spacer(1, 0.1*inch))

        for table_idx, table in enumerate(session.tables):
            participants_str = _format_table_participants_list(table, participants_df)
            story.append(Paragraph(f"<b>Table {table_idx + 1}</b> : {participants_str}", styles['Normal']))

        story.append(Spacer(1, 0.2*inch))

    # Build PDF
    doc.build(story, onFirstPage=_add_footer, onLaterPages=_add_footer)

    # Retourner buffer si pas de output_path
    if buffer:
        buffer.seek(0)
        return buffer

    return None


def _plotly_fig_to_image(fig, width=600, height=400):
    """Convertit figure Plotly en Image ReportLab.

    Utilise kaleido (ou orca) pour exporter Plotly ‚Üí PNG.
    """
    try:
        import plotly.io as pio
        import tempfile

        # Exporter en PNG via kaleido
        img_bytes = pio.to_image(fig, format='png', width=width, height=height, scale=2)

        # Cr√©er Image ReportLab depuis bytes
        from PIL import Image as PILImage
        import io

        pil_img = PILImage.open(io.BytesIO(img_bytes))

        # Sauvegarder temporairement
        with tempfile.NamedTemporaryFile(suffix='.png', delete=False) as tmp:
            pil_img.save(tmp.name)
            tmp_path = tmp.name

        # Cr√©er Image ReportLab
        img = Image(tmp_path, width=5*inch, height=3*inch)
        return img

    except Exception as e:
        # Si erreur (kaleido pas install√©), retourner None
        print(f"Erreur export graphique : {e}")
        return None


def _format_table_participants_list(table: set, participants_df: Optional[pd.DataFrame]) -> str:
    """Formate liste participants d'une table pour PDF."""
    sorted_ids = sorted(table)

    names = []
    for p_id in sorted_ids:
        name = get_participant_display_name(p_id, participants_df)
        names.append(name)

    return ", ".join(names)


def _add_footer(canvas, doc):
    """Ajoute footer sur chaque page."""
    canvas.saveState()
    canvas.setFont('Helvetica', 9)
    canvas.drawString(inch/2, 0.5*inch, "G√©n√©r√© par Speed Dating Planner")
    canvas.drawRightString(A4[0] - inch/2, 0.5*inch, f"Page {doc.page}")
    canvas.restoreState()
```

### 2. Int√©gration Streamlit (app/pages/4_üìà_R√©sultats.py)

Ajouter dans le tab "Exports" (Tab 3) :

```python
# Export PDF (Story 5.4)
st.divider()
st.markdown("#### üìÑ Rapport PDF Complet")
st.info("""
**Contenu du rapport PDF** :
- Page de garde avec configuration
- Score qualit√© et KPIs principaux
- Graphiques (heatmap, distribution, pie chart)
- Planning d√©taill√© (toutes sessions/tables)

**Format** : A4, haute r√©solution, pr√™t √† imprimer
""")

if config.N > 100:
    st.warning("‚ö†Ô∏è G√©n√©ration PDF peut prendre 10-15s pour N > 100")

if st.button("üìÑ G√©n√©rer Rapport PDF", use_container_width=True):
    with st.spinner("G√©n√©ration PDF en cours..."):
        try:
            from src.pdf_exporter import export_to_pdf

            # G√©n√©rer PDF en m√©moire
            pdf_bytes = export_to_pdf(planning, config, metrics, participants_df)

            # Nom fichier avec timestamp
            from datetime import datetime
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            filename = f"planning_report_{timestamp}.pdf"

            # Bouton download
            st.download_button(
                label="‚¨áÔ∏è T√©l√©charger Rapport PDF",
                data=pdf_bytes.getvalue(),
                file_name=filename,
                mime="application/pdf",
                use_container_width=True,
            )

            st.success("‚úÖ PDF g√©n√©r√© avec succ√®s !")

        except Exception as e:
            st.error(f"‚ùå Erreur g√©n√©ration PDF : {e}")
            st.info("üí° Astuce : V√©rifiez que `reportlab` et `kaleido` sont install√©s")
```

### 3. D√©pendances (requirements.txt)

Ajouter :
```
reportlab>=4.0.0
kaleido>=0.2.1
Pillow>=10.0.0
```

## Tasks d'Impl√©mentation

- [ ] **Task 1**: Installer d√©pendances (`reportlab`, `kaleido`, `Pillow`)
- [ ] **Task 2**: Cr√©er `src/pdf_exporter.py` avec fonction `export_to_pdf()`
- [ ] **Task 3**: Impl√©menter page de garde + KPIs
- [ ] **Task 4**: Impl√©menter export graphiques Plotly ‚Üí PNG
- [ ] **Task 5**: Impl√©menter planning d√©taill√©
- [ ] **Task 6**: Ajouter footer et m√©tadonn√©es
- [ ] **Task 7**: Int√©grer bouton PDF dans page R√©sultats
- [ ] **Task 8**: Tests manuels (N=10, N=50, avec/sans participants)

## Testing

### Tests Manuels

1. **G√©n√©ration PDF basique** :
   - G√©n√©rer planning N=20
   - Cliquer "G√©n√©rer Rapport PDF"
   - T√©l√©charger et ouvrir PDF
   - V√©rifier page de garde, KPIs, graphiques, planning

2. **Avec participants** :
   - Importer participants (CSV)
   - G√©n√©rer planning
   - PDF doit afficher noms (pas IDs)

3. **Grand planning** :
   - N=100
   - Warning affich√©
   - PDF g√©n√©r√© en < 15s

### Tests Unitaires (Optionnel)

Tests basiques pour s'assurer pas de crash :

```python
def test_export_to_pdf_basic():
    """Test export PDF basique sans crash."""
    from src.pdf_exporter import export_to_pdf

    config = PlanningConfig(N=10, X=2, x=5, S=3)
    planning = generate_baseline(config, seed=42)
    metrics = compute_metrics(planning, config)

    pdf_bytes = export_to_pdf(planning, config, metrics)

    # V√©rifier PDF g√©n√©r√©
    assert pdf_bytes is not None
    assert pdf_bytes.getvalue().startswith(b'%PDF')  # Header PDF
```

## Crit√®res de Succ√®s

- ‚úÖ PDF professionnel et imprimable
- ‚úÖ Page de garde avec configuration + score qualit√©
- ‚úÖ KPIs et m√©triques d√©taill√©es
- ‚úÖ Graphiques haute r√©solution (heatmap, distribution, pie)
- ‚úÖ Planning complet avec noms participants
- ‚úÖ Footer et num√©ros de page
- ‚úÖ G√©n√©ration < 5s pour N=50
- ‚úÖ Int√©gration Streamlit avec bouton download

## Temps Estim√©

- Impl√©mentation : 3h
- Tests : 1h
- Debug graphiques : 1h
- **Total : 5h**

## Notes Techniques

- **ReportLab** : Biblioth√®que standard Python pour PDFs
- **Kaleido** : Moteur export Plotly ‚Üí PNG (remplace Orca)
- **Pillow** : Manipulation images
- **BytesIO** : PDF en m√©moire pour st.download_button()
- **A4 vs Letter** : A4 par d√©faut (Europe), configurable

## Limitations Connues

- **Heatmap** : Peut √™tre illisible pour N > 50 (trop de cellules)
  - Solution : Ne pas inclure heatmap si N > 50, ou utiliser version simplifi√©e
- **Kaleido** : N√©cessite installation s√©par√©e
  - Fallback : Si kaleido absent, g√©n√©rer PDF sans graphiques (texte uniquement)
