# Story 5.1 : Afficher Noms des Participants

**Epic**: Epic 5 - Dashboards & Visualisation
**Priorit√©**: HAUTE (UX critique)
**Estimation**: 2 points
**Status**: In Progress

## Contexte

Actuellement, l'interface Streamlit et les exports affichent uniquement les **IDs num√©riques** des participants (ex: "Participants 1, 6, 11, 16"). Cela rend l'application difficile √† utiliser pour les organisateurs d'√©v√©nements qui veulent voir les **noms r√©els** (ex: "Jean Dupont, Marie Martin, Luc Bernard, Sophie Durand").

## Objectif

Afficher les **noms complets** (pr√©nom + nom) des participants partout dans l'interface et les exports, tout en gardant la **backward compatibility** pour les cas o√π aucune liste de participants n'est charg√©e.

## User Story

**En tant qu'** organisateur d'√©v√©nement
**Je veux** voir les noms r√©els des participants dans le planning
**Afin de** pouvoir facilement identifier qui est √† quelle table sans avoir √† consulter une liste d'IDs s√©par√©e

## Acceptance Criteria

### AC1: Format d'Affichage Noms
- [ ] Format nom : "Pr√©nom Nom" (ex: "Jean Dupont")
- [ ] Si pas de pr√©nom : "Nom" uniquement (ex: "Dupont")
- [ ] Si participant introuvable : afficher "Participant #ID" (fallback)
- [ ] Format avec VIP : "‚≠ê Pr√©nom Nom" pour les VIP

### AC2: Exports CSV
- [ ] CSV export inclut nouvelle colonne `participant_name` si participants charg√©s
- [ ] Format CSV : `session_id,table_id,participant_id,participant_name`
- [ ] Backward compatible : si pas de participants, colonne vide ou absente

### AC3: Exports JSON
- [ ] JSON export inclut `participant_name` dans chaque entr√©e si disponible
- [ ] Structure : `{"participant_id": 5, "participant_name": "Jean Dupont"}`
- [ ] Backward compatible : champ `participant_name` null si pas de participants

### AC4: Page R√©sultats - Aper√ßu Planning
- [ ] Section "Aper√ßu Planning" affiche noms au lieu d'IDs
- [ ] Format : "**Table 1** : Jean Dupont, Marie Martin, Luc Bernard"
- [ ] Tooltip sur survol : afficher ID + email si disponible

### AC5: Page G√©n√©ration - R√©sultats Rapides
- [ ] Apr√®s g√©n√©ration, aper√ßu affiche noms des participants
- [ ] Coh√©rent avec format de la page R√©sultats

### AC6: Page Dashboard (si applicable)
- [ ] Graphiques utilisent noms sur axes X si disponible
- [ ] L√©gendes affichent noms au lieu d'IDs

### AC7: Fonction Helper
- [ ] Cr√©er `get_participant_display_name(participant_id, participants_df)` helper
- [ ] Disponible dans module utils pour r√©utilisation
- [ ] G√®re tous les cas edge (None, introuvable, pas de pr√©nom, VIP)

## Design Technique

### 1. Helper Function (src/utils.py ou nouveau fichier)

```python
from typing import Optional
import pandas as pd

def get_participant_display_name(
    participant_id: int,
    participants_df: Optional[pd.DataFrame] = None,
    include_vip_badge: bool = False
) -> str:
    """Retourne nom d'affichage pour un participant.

    Args:
        participant_id: ID du participant
        participants_df: DataFrame participants (optionnel)
        include_vip_badge: Ajouter ‚≠ê si VIP

    Returns:
        Nom format√© ou fallback "Participant #ID"

    Example:
        >>> df = pd.DataFrame({"id": [0], "nom": ["Dupont"], "prenom": ["Jean"]})
        >>> get_participant_display_name(0, df)
        'Jean Dupont'
        >>> get_participant_display_name(99, df)
        'Participant #99'
    """
    if participants_df is None or participants_df.empty:
        return f"Participant #{participant_id}"

    # Chercher participant par ID
    participant = participants_df[participants_df["id"] == participant_id]

    if participant.empty:
        return f"Participant #{participant_id}"

    row = participant.iloc[0]
    nom = row.get("nom", "")
    prenom = row.get("prenom", "")

    # Format : "Pr√©nom Nom" ou "Nom" si pas de pr√©nom
    if pd.notna(prenom) and prenom:
        display_name = f"{prenom} {nom}"
    else:
        display_name = nom

    # Ajouter badge VIP si demand√©
    if include_vip_badge and row.get("is_vip", False):
        display_name = f"‚≠ê {display_name}"

    return display_name
```

### 2. Modifier Exporters

#### CSV Exporter (src/exporters.py)

```python
def export_to_csv(
    planning: Planning,
    config: PlanningConfig,
    output_path: str,
    participants: Optional[List[Participant]] = None
) -> None:
    """Export planning vers CSV avec noms si participants fournis."""
    rows = []

    # Cr√©er DataFrame participants si fourni
    participants_df = None
    if participants:
        participants_df = pd.DataFrame([p.__dict__ for p in participants])

    for session in planning.sessions:
        for table_id, table in enumerate(session.tables):
            for participant_id in table:
                row = {
                    "session_id": session.session_id,
                    "table_id": table_id,
                    "participant_id": participant_id,
                }

                # Ajouter nom si disponible
                if participants_df is not None:
                    row["participant_name"] = get_participant_display_name(
                        participant_id, participants_df
                    )

                rows.append(row)

    df = pd.DataFrame(rows)
    df.to_csv(output_path, index=False)
```

### 3. Modifier Pages Streamlit

#### Page R√©sultats (app/pages/4_üìà_R√©sultats.py)

```python
# R√©cup√©rer participants si disponibles
participants_df = st.session_state.get("participants", None)

# Preview planning
for session_idx, session in enumerate(planning.sessions[:3]):
    with st.expander(f"Session {session_idx + 1}/{config.S}"):
        for table_idx, table in enumerate(session.tables):
            # Afficher noms au lieu d'IDs
            if participants_df is not None:
                names = [
                    get_participant_display_name(p_id, participants_df, include_vip_badge=True)
                    for p_id in sorted(table)
                ]
                participants_str = ", ".join(names)
            else:
                participants_str = ", ".join(str(p) for p in sorted(table))

            st.write(f"**Table {table_idx + 1}** : {participants_str}")
```

## Tasks d'Impl√©mentation

- [ ] **Task 1**: Cr√©er helper `get_participant_display_name()` dans nouveau fichier `src/display_utils.py`
- [ ] **Task 2**: Modifier `export_to_csv()` pour accepter `participants` et ajouter colonne `participant_name`
- [ ] **Task 3**: Modifier `export_to_json()` pour inclure `participant_name` dans chaque entr√©e
- [ ] **Task 4**: Modifier page R√©sultats pour afficher noms dans aper√ßu planning
- [ ] **Task 5**: Modifier page G√©n√©ration pour afficher noms dans r√©sultats rapides
- [ ] **Task 6**: Modifier boutons download pour passer participants aux exporters
- [ ] **Task 7**: Tests unitaires pour `get_participant_display_name()`

## Testing

### Tests Unitaires (tests/test_display_utils.py)

```python
def test_get_participant_display_name_with_prenom():
    """Nom avec pr√©nom."""
    df = pd.DataFrame({"id": [0], "nom": ["Dupont"], "prenom": ["Jean"]})
    assert get_participant_display_name(0, df) == "Jean Dupont"

def test_get_participant_display_name_without_prenom():
    """Nom sans pr√©nom."""
    df = pd.DataFrame({"id": [0], "nom": ["Dupont"], "prenom": [None]})
    assert get_participant_display_name(0, df) == "Dupont"

def test_get_participant_display_name_not_found():
    """Participant introuvable."""
    df = pd.DataFrame({"id": [0], "nom": ["Dupont"], "prenom": ["Jean"]})
    assert get_participant_display_name(99, df) == "Participant #99"

def test_get_participant_display_name_no_dataframe():
    """Pas de DataFrame participants."""
    assert get_participant_display_name(5, None) == "Participant #5"

def test_get_participant_display_name_vip():
    """Affichage VIP avec badge."""
    df = pd.DataFrame({"id": [0], "nom": ["Dupont"], "prenom": ["Jean"], "is_vip": [True]})
    assert get_participant_display_name(0, df, include_vip_badge=True) == "‚≠ê Jean Dupont"
```

### Tests Manuels (Streamlit)

1. **Sans Participants Charg√©s**:
   - G√©n√©rer planning sans import CSV
   - V√©rifier affichage "Participant #0, Participant #1, ..."
   - V√©rifier exports CSV/JSON fonctionnent (sans colonne name)

2. **Avec Participants Charg√©s**:
   - Importer CSV avec noms
   - G√©n√©rer planning
   - V√©rifier affichage "Jean Dupont, Marie Martin, ..."
   - V√©rifier exports CSV/JSON incluent colonne `participant_name`

3. **Avec Participants VIP**:
   - Marquer certains participants VIP
   - V√©rifier badge ‚≠ê affich√© dans aper√ßu planning

## Notes Techniques

### Backward Compatibility
- Si `participants_df` est `None` ou vide ‚Üí afficher IDs (comportement actuel)
- Exports CSV/JSON fonctionnent avec ou sans participants
- Pas de breaking changes pour utilisateurs existants

### Performance
- Helper function O(1) lookup avec pandas .loc[]
- Pas d'impact significatif sur performance (op√©rations d'affichage uniquement)

### UX Improvements
- Badge VIP (‚≠ê) optionnel dans aper√ßu planning
- Tooltip avec ID + email sur survol (√† impl√©menter en Story 5.2+)
- Format coh√©rent partout dans l'app

## D√©pendances

- **Story 4.4** (VIP) : utilise `is_vip` pour badge ‚≠ê
- **Story 3.1** (Participants) : utilise DataFrame participants de session_state

## Crit√®res de Succ√®s

- ‚úÖ Noms affich√©s partout dans interface Streamlit
- ‚úÖ Exports CSV/JSON incluent noms
- ‚úÖ Backward compatible (fonctionne sans participants)
- ‚úÖ Tests unitaires passent
- ‚úÖ Tests manuels Streamlit OK

## Temps Estim√©

- Impl√©mentation : 1h
- Tests : 30min
- **Total : 1h30**
