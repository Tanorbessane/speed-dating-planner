# Story 4.1: Import Participants CSV/Excel

**Epic**: 4 - Gestion √âv√©nements R√©els
**Story ID**: 4.1
**Priority**: HIGH
**Status**: Completed (Code Complete - Tests Manuels Pending)
**Estimation**: 3 days ‚Üí Actual: 1 day
**Depends on**: Story 4.0 (Streamlit Skeleton)

---

## User Story

**As an** organisateur d'√©v√©nement,
**I want** importer une liste de participants depuis CSV/Excel,
**So that** je n'ai pas √† saisir manuellement 50-300 noms.

---

## Acceptance Criteria

### Upload & Parsing
1. ‚úÖ Widget `st.file_uploader` accepte `.csv` et `.xlsx`
2. ‚úÖ Parser d√©tecte automatiquement d√©limiteur CSV (`,` ou `;`)
3. ‚úÖ Lecture Excel supporte multiples feuilles (s√©lection sheet)
4. ‚úÖ Encodage UTF-8 g√©r√© automatiquement

### Mapping Colonnes
5. ‚úÖ Interface permet de mapper colonnes fichier ‚Üí champs syst√®me :
   - `participant_id` (optionnel, auto-g√©n√©r√© si absent)
   - `nom` (requis)
   - `prenom` (optionnel)
   - `email` (optionnel, format valid√©)
   - `groupe` (optionnel, pour contraintes futures)
   - `tags` (optionnel, ex: "VIP,Speaker")
6. ‚úÖ Preview 10 premi√®res lignes avant import (avec mapping appliqu√©)
7. ‚úÖ Option "Ignorer ligne 1" (si header dans fichier)

### Validation
8. ‚úÖ D√©tection doublons (m√™me nom+pr√©nom ou m√™me email)
9. ‚úÖ Validation email format (regex RFC 5322 basique)
10. ‚úÖ Alerte si colonne requise (`nom`) manquante
11. ‚úÖ Rapport validation :
    - Nombre lignes valides
    - Nombre doublons d√©tect√©s
    - Emails invalides
    - Champs manquants

### Stockage
12. ‚úÖ Participants stock√©s dans `st.session_state.participants` (DataFrame)
13. ‚úÖ Auto-g√©n√©ration `participant_id` si absent (0, 1, 2, ...)
14. ‚úÖ Sauvegarde optionnelle en JSON local (`data/participants.json`)

### Export Template
15. ‚úÖ Bouton "T√©l√©charger Template CSV" (fichier exemple)
16. ‚úÖ Template inclut 5 lignes exemples avec toutes colonnes
17. ‚úÖ Instructions dans placeholder page existante

### UX
18. ‚úÖ Messages d'erreur explicites en fran√ßais
19. ‚úÖ Barre de progression pour gros fichiers (>100 lignes)
20. ‚úÖ Bouton "R√©initialiser" pour r√©importer

---

## Technical Design

### Data Model
```python
# src/models.py (nouveau)
from dataclasses import dataclass
from typing import Optional

@dataclass
class Participant:
    """Repr√©sente un participant √† l'√©v√©nement."""
    id: int
    nom: str
    prenom: Optional[str] = None
    email: Optional[str] = None
    groupe: Optional[str] = None
    tags: list[str] = None  # Ex: ["VIP", "Speaker"]

    def __post_init__(self):
        if self.tags is None:
            self.tags = []
```

### Module Import
```python
# src/participants.py (nouveau)
import pandas as pd
from typing import Tuple, List
from src.models import Participant

def parse_csv(filepath: str) -> pd.DataFrame:
    """Parse CSV avec d√©tection auto d√©limiteur."""
    pass

def parse_excel(filepath: str, sheet_name: str = 0) -> pd.DataFrame:
    """Parse Excel sheet."""
    pass

def validate_participants(df: pd.DataFrame) -> Tuple[List[Participant], List[str]]:
    """
    Valide DataFrame et retourne (participants_valides, erreurs).

    Returns:
        participants: Liste Participant objects
        errors: Liste messages erreur (doublons, emails invalides, etc.)
    """
    pass

def auto_generate_ids(df: pd.DataFrame) -> pd.DataFrame:
    """Auto-g√©n√®re participant_id si colonne absente."""
    pass

def validate_email(email: str) -> bool:
    """Valide format email (regex basique)."""
    import re
    pattern = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
    return re.match(pattern, email) is not None
```

### Interface Streamlit
```python
# app/pages/5_üë•_Participants.py (refactor)
import streamlit as st
import pandas as pd
from src.participants import parse_csv, parse_excel, validate_participants

uploaded_file = st.file_uploader("üì• Importer participants", type=["csv", "xlsx"])

if uploaded_file:
    # Parse selon extension
    if uploaded_file.name.endswith('.csv'):
        df = parse_csv(uploaded_file)
    else:
        df = parse_excel(uploaded_file)

    # Mapping colonnes
    st.subheader("üîó Mapper les colonnes")
    col_mappings = {}
    for field in ["nom", "prenom", "email", "groupe", "tags"]:
        col_mappings[field] = st.selectbox(
            f"Colonne pour '{field}'",
            options=["(Ne pas importer)"] + list(df.columns)
        )

    # Preview
    st.subheader("üëÄ Preview (10 premi√®res lignes)")
    st.dataframe(df.head(10))

    # Validation
    if st.button("‚úÖ Valider et Importer"):
        participants, errors = validate_participants(df)

        if errors:
            st.error(f"‚ùå {len(errors)} erreur(s) d√©tect√©e(s)")
            for err in errors:
                st.warning(err)
        else:
            st.session_state.participants = pd.DataFrame([p.__dict__ for p in participants])
            st.success(f"‚úÖ {len(participants)} participants import√©s !")
```

---

## Tasks

### Backend
- [x] Cr√©er `src/participants.py` avec :
  - `parse_csv()` (d√©tection auto d√©limiteur)
  - `parse_excel()` (support multisheets)
  - `validate_participants()` (doublons, emails)
  - `auto_generate_ids()`
  - `validate_email()`
  - `normalize_dataframe()` (bonus: normalisation donn√©es)
  - `find_duplicates()` (d√©tection doublons)
- [x] √âtendre `src/models.py` avec dataclass `Participant`
- [x] Tests unitaires `tests/test_participants.py` :
  - Import CSV valide ‚úÖ
  - D√©tection doublons ‚úÖ
  - Validation emails ‚úÖ
  - Auto-g√©n√©ration IDs ‚úÖ
  - 29 tests PASSED ‚úÖ

### Frontend
- [x] Refactor `app/pages/5_üë•_Participants.py` :
  - File uploader CSV/Excel ‚úÖ
  - Mapping colonnes interactif ‚úÖ
  - Preview 10 premi√®res lignes ‚úÖ
  - Rapport validation d√©taill√© ‚úÖ
  - Statistiques temps r√©el ‚úÖ
- [x] Template CSV t√©l√©chargeable (int√©gr√© dans page)
- [ ] Cr√©er composant `app/components/participant_table.py` (optionnel, pas n√©cessaire)

### Documentation
- [ ] Mettre √† jour `app/README.md` avec section "Import Participants" (TODO)
- [x] Ajouter exemple CSV dans `examples/participants_sample.csv` (30 participants)
- [ ] Screenshot workflow import (TODO: manuel user)

### Tests Manuels
- [ ] Import CSV 10 participants (valide) - TODO user
- [ ] Import Excel 50 participants (multisheets) - TODO user
- [ ] D√©tection doublons (2 m√™mes noms) - TODO user
- [ ] Validation email invalide (`user@com`) - TODO user
- [ ] Mapping colonnes incorrectes (colonne `nom` vide) - TODO user
- [ ] Fichier >100 lignes (performance) - TODO user

---

## Dev Notes

### D√©pendances Suppl√©mentaires
```bash
# Pandas d√©j√† install√© (Story 4.0)
# Ajouter support Excel
poetry add openpyxl  # Pour lecture .xlsx
```

### D√©tection Auto D√©limiteur CSV
```python
import csv

def detect_delimiter(filepath: str) -> str:
    """D√©tecte d√©limiteur CSV (, ou ;)."""
    with open(filepath, 'r', encoding='utf-8') as f:
        sample = f.read(1024)
        sniffer = csv.Sniffer()
        delimiter = sniffer.sniff(sample).delimiter
    return delimiter
```

### Validation Email Regex
```python
# Pattern basique (√©viter regex complexe RFC 5322 compl√®te)
import re

EMAIL_PATTERN = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'

def validate_email(email: str) -> bool:
    return bool(re.match(EMAIL_PATTERN, email))
```

### Gestion Doublons
```python
def find_duplicates(df: pd.DataFrame) -> List[str]:
    """Trouve doublons bas√©s sur (nom, prenom) ou email."""
    duplicates = []

    # Doublons nom+prenom
    name_dupes = df[df.duplicated(subset=['nom', 'prenom'], keep=False)]
    if not name_dupes.empty:
        for _, row in name_dupes.iterrows():
            duplicates.append(f"Doublon : {row['nom']} {row['prenom']}")

    # Doublons email
    if 'email' in df.columns:
        email_dupes = df[df.duplicated(subset=['email'], keep=False)]
        for _, row in email_dupes.iterrows():
            duplicates.append(f"Email doublon : {row['email']}")

    return duplicates
```

---

## Definition of Done

- [x] Module `src/participants.py` cr√©√© avec toutes fonctions
- [x] Dataclass `Participant` ajout√©e √† `src/models.py`
- [x] Tests unitaires `tests/test_participants.py` passent (29/29 ‚úÖ)
- [x] Page `5_üë•_Participants.py` refactor√©e et fonctionnelle
- [x] Template CSV t√©l√©chargeable (int√©gr√© dans page)
- [x] Exemple CSV cr√©√© (`examples/participants_sample.csv`)
- [ ] Workflow import test√© manuellement (checklist ci-dessus) - TODO user
- [ ] Documentation `app/README.md` mise √† jour - TODO
- [ ] Screenshots ajout√©s - TODO user

---

## Completion Notes

**Date**: 2026-01-12
**Developer**: James (Dev Agent)

### Impl√©mentation Compl√®te

**Backend (100% compl√©t√©):**
- ‚úÖ Module `src/participants.py` cr√©√© (400+ lignes)
  - `validate_email()` : Regex RFC 5322 basique
  - `detect_delimiter()` : Auto-d√©tection CSV (, ou ;)
  - `parse_csv()` : Parsing avec d√©tection d√©limiteur
  - `parse_excel()` : Support multisheets + index
  - `normalize_dataframe()` : Strips, capitalize, lowercase email
  - `auto_generate_ids()` : G√©n√©ration IDs 0,1,2...
  - `find_duplicates()` : D√©tection nom+pr√©nom et email
  - `validate_participants()` : Pipeline complet validation
- ‚úÖ Dataclass `Participant` ajout√©e √† `src/models.py`
  - Champs: id, nom, prenom, email, groupe, tags
  - Property `full_name` : "Pr√©nom Nom"
  - Validation __post_init__
- ‚úÖ Tests unitaires : **29 tests PASSED en 33.49s**
  - 8 classes de tests
  - Couverture compl√®te : validation, parsing, normalisation, doublons

**Frontend (100% compl√©t√©):**
- ‚úÖ Page `5_üë•_Participants.py` compl√®tement refactoris√©e (325 lignes)
  - Section 1: Template t√©l√©chargeable (expander)
  - Section 2: Upload fichier (CSV + XLSX)
  - Section 3: Mapping colonnes interactif (6 champs)
    - Auto-d√©tection colonnes si noms matchent
    - Option "Ignorer ligne 1" si header
  - Section 4: Preview 10 premi√®res lignes
  - Section 5: Validation et import
    - Rapport d√©taill√© : lignes trait√©es, valides, erreurs, taux validit√©
    - Affichage erreurs dans expander
    - Import dans `st.session_state.participants`
  - Section 6: Participants actuels
    - Statistiques : emails, groupes, tags
    - Sauvegarde JSON local (`data/participants.json`)
    - Bouton suppression liste

**Exemple & Template:**
- ‚úÖ `examples/participants_sample.csv` : 30 participants
  - Mix : avec/sans email, avec/sans groupe, avec tags vari√©s
  - Pr√™t pour tests import

### Features Impl√©ment√©es

**‚úÖ CSV + XLSX Support:**
- D√©tection auto d√©limiteur (, ou ;)
- Multisheets Excel (s√©lection dropdown)
- Encodage UTF-8 automatique

**‚úÖ Mapping Colonnes:**
- 6 champs mappables : nom, prenom, email, groupe, tags, participant_id
- Auto-d√©tection si colonnes exactes pr√©sentes
- Option "(Ne pas importer)" pour chaque champ

**‚úÖ Normalisation:**
- Strips whitespace
- Capitalize nom/pr√©nom
- Lowercase email
- Cha√Ænes vides ‚Üí None

**‚úÖ D√©duplication:**
- D√©tection doublons nom+pr√©nom
- D√©tection doublons email
- Comptage occurrences

**‚úÖ Rapport d'Erreurs:**
- Colonnes manquantes
- Emails invalides (regex)
- Doublons d√©tect√©s
- Lignes sans nom
- Erreurs parsing (ligne par ligne)

### Tests Manuels Restants

Pour valider compl√®tement Story 4.1, user doit tester :
1. Upload `examples/participants_sample.csv` (30 participants)
2. Cr√©er fichier Excel multisheets et tester s√©lection
3. Tester mapping colonnes avec noms diff√©rents
4. V√©rifier d√©tection doublons (cr√©er CSV avec 2x "Dupont Jean")
5. V√©rifier validation email (ajouter "invalid@com")
6. Tester fichier 100+ lignes (performance)
7. Capturer screenshots workflow complet

---

## Change Log

| Date | Author | Change |
|------|--------|--------|
| 2026-01-12 | James | Story cr√©√©e |
| 2026-01-12 | James | Impl√©mentation compl√®te backend + frontend + tests (29/29 PASSED) |
