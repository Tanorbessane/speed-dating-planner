# Story 3.1: Implémenter l'Exporteur CSV

## Status

**Draft**

---

## Story

**As a** organisateur d'événement,
**I want** exporter mon planning au format CSV,
**so that** je peux l'importer dans Excel, Google Sheets ou mon système de gestion d'événements.

---

## Acceptance Criteria

1. Un module `src/exporters.py` contient une fonction `export_to_csv(planning: Planning, config: PlanningConfig, filepath: str) -> None`
2. Le fichier CSV généré contient exactement les colonnes : `session_id`, `table_id`, `participant_id` (FR10)
3. Les IDs sont des entiers (0-indexed pour participants, 0-indexed pour sessions, 0-indexed pour tables)
4. Le fichier est encodé en UTF-8 avec BOM pour compatibilité Excel
5. Les tests dans `tests/test_exporters.py` vérifient :
   - Export réussit sans erreur pour planning valide
   - Fichier CSV produit contient bon nombre de lignes (N × S)
   - Lecture du CSV avec `csv.DictReader` fonctionne
   - Valeurs correctes pour un planning connu
6. La fonction gère correctement les chemins avec espaces et caractères spéciaux
7. Si le fichier existe déjà, il est écrasé (avec warning loggé)

---

## Tasks / Subtasks

- [ ] **Task 1: Créer module exporters.py** (AC: 1)
  - [ ] Créer `src/exporters.py`
  - [ ] Importer: csv, json, logging, Path from pathlib
  - [ ] Importer: Planning, PlanningConfig from src.models
  - [ ] Initialiser logger

- [ ] **Task 2: Implémenter export_to_csv()** (AC: 1, 2, 3, 4, 6, 7)
  - [ ] Signature:
    ```python
    def export_to_csv(
        planning: Planning,
        config: PlanningConfig,
        filepath: str
    ) -> None
    ```
  - [ ] Docstring Google style: args, raises IOError, example
  - [ ] Créer Path object, gérer chemins avec espaces
  - [ ] Vérifier si fichier existe: logger.warning si écrasement
  - [ ] Ouvrir fichier avec encoding='utf-8-sig' (BOM pour Excel)
  - [ ] Créer csv.writer
  - [ ] Écrire header: ['session_id', 'table_id', 'participant_id']
  - [ ] Pour chaque session:
    - Pour chaque table (enumerate pour table_id):
      - Pour chaque participant (sorted pour déterminisme):
        - Écrire row: [session_id, table_id, participant_id]
  - [ ] Logger success: "Export CSV réussi : {filepath} ({N×S} lignes)"

- [ ] **Task 3: Créer tests test_exporters.py** (AC: 5)
  - [ ] Créer `tests/test_exporters.py`
  - [ ] Importer: pytest, csv, Path, tempfile
  - [ ] Importer: export_to_csv, Planning, PlanningConfig, Session

- [ ] **Task 4: Test export réussit** (AC: 5)
  - [ ] Créer planning test simple (N=6, S=2)
  - [ ] Créer fichier temporaire (tempfile.NamedTemporaryFile)
  - [ ] Appeler export_to_csv
  - [ ] Vérifier fichier créé
  - [ ] Vérifier nombre de lignes: header + N×S data rows

- [ ] **Task 5: Test lecture CSV avec DictReader** (AC: 5)
  - [ ] Exporter planning test
  - [ ] Lire fichier avec csv.DictReader
  - [ ] Vérifier colonnes: 'session_id', 'table_id', 'participant_id'
  - [ ] Vérifier valeurs sont des entiers parsables

- [ ] **Task 6: Test valeurs correctes** (AC: 5)
  - [ ] Créer planning connu manuellement:
    - Session 0: table 0 = {0,1}, table 1 = {2,3}
    - Session 1: table 0 = {0,2}, table 1 = {1,3}
  - [ ] Exporter
  - [ ] Lire CSV et vérifier lignes exactes attendues

- [ ] **Task 7: Test gestion chemins spéciaux** (AC: 6)
  - [ ] Tester avec chemin contenant espaces: "/tmp/test planning.csv"
  - [ ] Tester avec caractères accentués: "/tmp/planníng.csv"
  - [ ] Vérifier export réussit

- [ ] **Task 8: Test écrasement fichier existant** (AC: 7)
  - [ ] Créer fichier CSV existant
  - [ ] Appeler export_to_csv avec même chemin
  - [ ] Capturer logs (caplog)
  - [ ] Vérifier WARNING loggé
  - [ ] Vérifier fichier écrasé avec nouveau contenu

- [ ] **Task 9: Test encodage UTF-8 BOM** (AC: 4)
  - [ ] Exporter planning
  - [ ] Lire fichier en mode binaire
  - [ ] Vérifier présence BOM: b'\xef\xbb\xbf' au début

- [ ] **Task 10: Valider couverture et qualité**
  - [ ] `pytest tests/test_exporters.py::test_export_csv -v`
  - [ ] `pytest tests/test_exporters.py --cov=src.exporters --cov-report=term --cov-fail-under=90`
  - [ ] `mypy src/exporters.py --strict`
  - [ ] `black` et `ruff` passent

- [ ] **Task 11: Créer QA Gate YAML**
  - [ ] Créer `docs/qa/gates/3.1-exporteur-csv.yml`

---

## Dev Notes

### Dépendance

**Epic 1-2 complets:**
- Models (Planning, PlanningConfig, Session)
- Pipeline génération (pour tests)

Cette story implémente **FR10** (export CSV).

### Implémentation Exacte

[Source: docs/architecture/interfaces-entre-modules.md#3.7]

```python
import csv
import logging
from pathlib import Path
from src.models import Planning, PlanningConfig

logger = logging.getLogger(__name__)


def export_to_csv(
    planning: Planning,
    config: PlanningConfig,
    filepath: str
) -> None:
    """
    Exporte planning au format CSV (FR10).

    Format: session_id, table_id, participant_id
    - Encodage UTF-8 avec BOM (compatibilité Excel)
    - Écrase fichier si existe

    Args:
        planning: Planning à exporter
        config: Configuration (pour contexte)
        filepath: Chemin fichier sortie

    Raises:
        IOError: Si impossible d'écrire le fichier

    Example:
        session_id,table_id,participant_id
        0,0,5
        0,0,12
        0,1,3
        ...
    """
    output_path = Path(filepath)
    if output_path.exists():
        logger.warning(f"Fichier existant écrasé : {filepath}")

    with open(output_path, 'w', encoding='utf-8-sig', newline='') as f:
        writer = csv.writer(f)
        writer.writerow(['session_id', 'table_id', 'participant_id'])

        for session in planning.sessions:
            for table_id, table in enumerate(session.tables):
                for participant_id in sorted(table):
                    writer.writerow([session.session_id, table_id, participant_id])

    total_rows = sum(len(t) for s in planning.sessions for t in s.tables)
    logger.info(f"Export CSV réussi : {filepath} ({total_rows} lignes)")
```

### Format CSV - FR10

**Colonnes exactes:**
- `session_id`: Entier 0-indexed (session 0, 1, 2, ...)
- `table_id`: Entier 0-indexed par session (table 0, 1, 2, ...)
- `participant_id`: Entier 0-indexed (participant 0, 1, ..., N-1)

**Exemple (N=6, X=2, S=2):**
```csv
session_id,table_id,participant_id
0,0,0
0,0,1
0,0,2
0,1,3
0,1,4
0,1,5
1,0,0
1,0,3
...
```

### Encodage UTF-8 avec BOM

**Pourquoi BOM ?**
- Excel (Windows) ne détecte pas automatiquement UTF-8 sans BOM
- Caractères accentués français affichés incorrectement sans BOM
- BOM = Byte Order Mark = `\xef\xbb\xbf` en début de fichier

**Python:**
- `encoding='utf-8-sig'` ajoute automatiquement BOM
- Compatible Excel, Google Sheets, LibreOffice

### Gestion Chemins Spéciaux

**Chemins avec espaces:**
```python
filepath = "/tmp/mon planning.csv"  # OK avec Path
```

**Chemins avec accents:**
```python
filepath = "/tmp/planníng_été.csv"  # OK UTF-8
```

**Path vs str:**
- Utiliser `Path(filepath)` pour robustesse cross-platform
- Gère automatiquement séparateurs Windows/Unix

---

## Testing

### Tests Exhaustifs

**1. Test export réussit**
```python
from tempfile import NamedTemporaryFile

def test_export_to_csv_success():
    config = PlanningConfig(N=6, X=2, x=3, S=2)
    sessions = [
        Session(0, [{0,1,2}, {3,4,5}]),
        Session(1, [{0,3,4}, {1,2,5}])
    ]
    planning = Planning(sessions, config)

    with NamedTemporaryFile(mode='w', delete=False, suffix='.csv') as f:
        filepath = f.name

    export_to_csv(planning, config, filepath)

    # Vérifier fichier créé
    assert Path(filepath).exists()

    # Compter lignes
    with open(filepath) as f:
        lines = f.readlines()
    assert len(lines) == 1 + 12  # header + 6×2 data rows
```

**2. Test lecture CSV**
```python
def test_export_to_csv_readable():
    # ... export planning
    with open(filepath) as f:
        reader = csv.DictReader(f)
        rows = list(reader)

    assert len(rows) == 12
    assert all('session_id' in row for row in rows)
    assert all('table_id' in row for row in rows)
    assert all('participant_id' in row for row in rows)
```

**3. Test valeurs correctes**
```python
def test_export_to_csv_correct_values():
    # Planning connu: Session 0, table 0 = {0,1}
    # ... export
    with open(filepath) as f:
        reader = csv.DictReader(f)
        first_row = next(reader)

    assert first_row['session_id'] == '0'
    assert first_row['table_id'] == '0'
    assert first_row['participant_id'] in ['0', '1']
```

**4. Test encodage BOM**
```python
def test_export_to_csv_utf8_bom():
    # ... export
    with open(filepath, 'rb') as f:
        first_bytes = f.read(3)
    assert first_bytes == b'\xef\xbb\xbf'  # UTF-8 BOM
```

---

## QA Gate

**Fichier:** `docs/qa/gates/3.1-exporteur-csv.yml`

```yaml
story: 3.1-exporteur-csv
checks:
  - name: Unit Tests
    command: pytest tests/test_exporters.py::test_export_csv -v
    expected: All tests pass

  - name: Coverage
    command: pytest tests/test_exporters.py --cov=src.exporters --cov-report=term --cov-fail-under=90
    expected: Coverage ≥90%

  - name: Type Checking
    command: mypy src/exporters.py --strict
    expected: No errors

  - name: Code Formatting
    command: black --check src/exporters.py tests/test_exporters.py
    expected: All files formatted

  - name: Linting
    command: ruff check src/exporters.py tests/test_exporters.py
    expected: No violations

  - name: CSV Format Validation
    command: python -c "import csv; f=open('test.csv'); list(csv.DictReader(f))"
    expected: CSV readable
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-10 | 1.0 | Story initiale créée par Scrum Master | Bob (SM) |

---

**Definition of Done:**
- [ ] `src/exporters.py` créé avec export_to_csv()
- [ ] Tests `test_exporters.py::test_export_csv_*` créés
- [ ] Format CSV: session_id, table_id, participant_id (FR10)
- [ ] Encodage UTF-8 avec BOM (compatibilité Excel)
- [ ] Test lecture CSV avec DictReader
- [ ] Test valeurs correctes pour planning connu
- [ ] Test gestion chemins avec espaces et accents
- [ ] Test écrasement fichier: WARNING loggé
- [ ] Couverture ≥90%
- [ ] `mypy --strict` passe
- [ ] `black` et `ruff` passent
- [ ] QA Gate YAML créé
- [ ] **Granularité:** 1 story = 1 PR (exporteur CSV uniquement)
